{% extends "base.html" %}

{% load i18n %}
{% load humanize %}

{% block title %}Ver sugerencia{% endblock %}
{% block extra_js %}
    <script src="/static/webapp/js/jquery.tmpl.min.js"></script>
    <script src="/static/facebookApp/js/grm.js"></script>
    
    
    <script type="text/javascript">
    $(document).ready(function(){
       
       
        setBehaviourToSuggestion();
        
        
        $('.LikeComment').click(function(){
            vote('comment',$(this),1)
        });
        $('.dontLikeComment').click(function(){
            vote('comment',$(this),-1)
        });
        
        $('.LikeSuggestion').click(function(){
            vote('suggestion',$(this),1)
        });
        $('.dontLikeSuggestion').click(function(){
            vote('suggestion',$(this),-1)
        });
    });
    
    function vote(type,obj,value){
        var element_id=obj.attr('value')
        
        $.ajax({
                type: "POST",
                url: "/ajax/vote/"+type+"/",
                data: {
                    instance_id:element_id,
                    puntuation: value,
                },
                complete: function(msg){
                    if (msg.status !=200){

                    }else{
                        console.log(msg.responseText)
                        //if(msg.responseText!=false){
                            action=obj.attr('class')
                            obj.addClass('hidden')
                            
                            if(action=="LikeComment")
                                obj.parent().find(".dontLikeComment").removeClass('hidden')
                            else if (action=="dontLikeComment")
                                obj.parent().find(".LikeComment").removeClass('hidden')
                                
                            if(action=="LikeSuggestion likeBtn btn")
                                obj.parent().find(".dontLikeSuggestion").removeClass('hidden')
                            else if (action=="dontLikeSuggestion likeBtn btn")
                                obj.parent().find(".LikeSuggestion").removeClass('hidden')
                        //}
                    }
                    
                }
            });
    }
    
    function setBehaviourToSuggestion(){
        //Behaviour to: show and hide "Like" text on class suggestion-element
       $('.suggestion-element').hover(
           function(){$(this).find('.votes').removeClass('hidden');},
           function(){$(this).find('.votes').addClass('hidden');}
        );
    }
    
    function sendComment(obj){
        if($('#msg').val()=="")
            return false;
        $(obj).text("Enviando")
        $(obj).addClass("waiting")
        
        $.ajax({
            type: "POST",
            url: "/ajax/add/comment/event/",
            data: {
                instance_id:{{suggestion.id}},
                msg:$('#msg').val()
            },
            complete: function(msg){
                if (msg.status !=200){

                }else{
                    var message=$('#msg').val()
                    $('#msg').val("")
                    
                    var response=jQuery.parseJSON(msg.responseText);
                    
                    
                    //console.log(response.msg)
                    c=$('#commentTemplate').tmpl( {
                        msg: response.msg,
                        comment_id: response.id,
                    }).prependTo('#comment-list');
                    
                    setBehaviourToSuggestion();
                    var objeto=$(c).find('.LikeComment')

                    c.find('.LikeComment').click(function(){
                        vote('comment',objeto,1)
                    });
                    c.find('.dontLikeComment').click(function(){
                        vote('comment',objeto,-1)
                    });

                    
                }
                $(obj).val("Enviar")
                $(obj).removeClass("waiting")
            }
        });
    }
    
    // not used
    function voteSuggestion(id,puntuation){
            
            $.ajax({
                    type: "POST",
                    url: "/ajax/vote/suggestion/",
                    data: {
                        instance_id:id,
                        puntuation: puntuation,//$('#suggestion_'+id).find('.like').attr('value'),
                    },
                    complete: function(msg){
                        if (msg.status !=200){
//                            $(this).text("Error "+msg.status)
//                            $('#error-msg').fadeIn('slow').delay(2000).fadeOut('slow')
                        }else{
                            if($('#suggestion_'+id).find('.like').attr('value')==1){
                            //$('#suggestion_'+value.value).fadeOut('slow').remove()
                                $('#suggestion_'+id).find('.like').text("Ya no me gusta");
                                $('#suggestion_'+id).find('.like').attr('value',-1);
                            }
                            else{
                                $('#suggestion_'+id).find('.like').text("Me gusta");
                                $('#suggestion_'+id).find('.like').attr('value',1);
                            }
                            $(document).find('.like-text').toggle();
                        }
                        
                    }
                });
        }
    </script>
{%endblock%}

{% block body %}
    <div id="view-suggestion">
        <div id="autor">
            <a href="/user/{{suggestion.user.username}}/picture/"><img src="/user/{{suggestion.user.username}}/picture/" alt="{{suggestion.user.username}} avatar"></a>
            <p>
                <a href="/fb{{suggestion.user.get_absolute_url}}">{{suggestion.user.username}}</a>
                sugiere:
            </p>
        </div>
        <div class="suggestion">
            <h1>{{suggestion.name}}</h1>
            {% if suggestion.description %}
                <p><strong>Instrucciones/explicación</strong>: {{suggestion.description}} </p>
            {% endif %}    

            <a title="Más detalles sobre: {{suggestion.poi.name}}" href="/fb{{suggestion.poi.get_absolute_url}}"><img src="http://maps.googleapis.com/maps/api/staticmap?center={{suggestion.poi.location}}&zoom=14&size=210x100&maptype=roadmap
&markers=color:blue%7Clabel:S%7C{{suggestion.poi.location}}&sensor=false"></a>
            
            <p>
                <strong>Lugar</strong>: <a href="/fb{{suggestion.poi.get_absolute_url}}">{{suggestion.poi.name}}</a>, <br>
                <strong>Dirección</strong>: {{suggestion.poi.address}}<br>
                {% if suggestion.date_starts or suggestion.date_ends %}
                    <strong>Fecha</strong>: 
                    [25/04/2011 al 30/05/2011]<br>
                {% endif %}
                
                
                <strong>Palabras clave</strong>: <a href="">ocio</a> | <a href="">granada</a><br>
            </p>

            <p>Reportar localización errónea</p>
<!--
            <p>Reportar sugerencia duplicada</p>
-->
        </div>

        
        
        {% if has_voted %}
            <span class="dontLikeSuggestion likeBtn btn" value="{{suggestion.id}}">
                Ya no me gusta
            </span>
            
            <span class="LikeSuggestion hidden likeBtn btn" value="{{suggestion.id}}">
                Me gusta
            </span>
        {% else %}
            <span class="dontLikeSuggestion hidden likeBtn btn" value="{{suggestion.id}}">
                Ya no me gusta
            </span>
            
            <span class="LikeSuggestion likeBtn btn" value="{{suggestion.id}}">
                Me gusta
            </span>
        {% endif %}
        
        <span class="btn likeBtn">Recordar</span>
        
        
<!--
        <p class="popular">Comentario más popular</p>
        <div id="comments" class="comments suggestion-element">
            <span class="user"><img src="/user/susana/picture/" alt="user avatar"><br><a href="">Pack</a></span>
            <span class="msg">Deberíais tomar unas cerveza mientras</span>
            <span class="timestamp">
                hace 5 min
                <span class="hoverlink like">Me gusta</span>
            </span>
        </div>
-->
        <p class="clear big">¿Tienes algo que añadir a esta sugerencia?</p>
        <textarea id="msg"></textarea>
<!--
        <ul id="feeling">
            <li>Happy</li>
            <li>Glad</li>
            <li>Sad</li>
        </ul>
-->
        <span class="btn" onclick="sendComment(this)">Comentar</span>
        
        {% if comments %}
        <ul class="comments" id="comment-list">
            {% for c in comments.1 %}
                <li class="suggestion-element">
                    <span class="user"><img src="/user/{{c.username}}/picture/" alt="{{c.username}} avatar"><br><a href="">{{c.username}}</a></span>
                    <span class="msg">{{c.msg}}</span>
                    <span class="timestamp">
                        {{c.created|timesince}}
                        <br>
                        <span class="votes hidden">
                        {% if c.has_voted %}
                            <span class="dontLikeComment" value="{{c.id}}">
                                <span class="hoverlink">Ya no me gusta</span> 
                                <span class="text like-text">{{c.vote_counter}}</span> personas
                            </span>
                            
                            <span class="LikeComment hidden" value="{{c.id}}">
                                <span class="hoverlink">Me gusta</span> 
                            </span>

                        {% else %}
                            
                            <span class="dontLikeComment hidden" value="{{c.id}}">
                                <span class="hoverlink">Ya no me gusta</span> 
                                <span class="text increase like-text">{{c.vote_counter}}</span> personas
                            </span>
                            
                            <span class="LikeComment" value="{{c.id}}">
                                <span class="hoverlink">Me gusta</span> 
                            </span>

                            
                        {% endif %}
                    </span>
                    </span>
                    
                </li>
            {% endfor %}

        </ul>
        {% endif %}
    </div>
    
    <script id="commentTemplate" type="text/x-jquery-tmpl">
        <li class="suggestion-element">
                <span class="user"><img src="/user/{{user.username}}/picture/" alt="user avatar"><br><a href="">{{user.username}}</a></span>
                <span class="msg">${msg}</span>
                <span class="timestamp">
                    hace 0 min<br>
                    <span class="votes hidden">
                        <span class="dontLikeComment hidden" value="${comment_id}">
                            <span class="hoverlink">Ya no me gusta</span> 
                            <span class="text increase like-text">1</span> persona
                        </span>
                        
                        <span class="LikeComment" value="${comment_id}">
                            <span class="hoverlink">Me gusta</span> 
                        </span>
                    </span>
                </span>
            </li>
    </script>
{% endblock %}
