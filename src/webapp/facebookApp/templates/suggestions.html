{% extends "base.html" %}

{% block title %}Baúl de sugerencias{% endblock %}

{% block extra_js %}
    <script src="/static/webapp/js/jquery.tmpl.min.js"></script>
    <script src="/static/facebookApp/js/grm.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="/static/facebookApp/js/jquery.hoverIntent.minified.js"></script>
    <script type="text/javascript">        
        $(document).ready(function(){
            
            //Asignamos comportamiento ONCLICK a cada fila
            $('.suggestionName').click(function(){
                    $(this).parent().parent().find('div.collapsed').slideToggle('fast','swing',function(){
                        $(this).parent().find('div.expanded').slideToggle('fast','swing')    
                    })
                    
            });
            $('.collapseBtn').click(function(){
                    $(this).parent().parent().find('div.expanded').slideToggle('fast','swing',function(){
                        $(this).parent().find('div.collapsed').slideToggle('fast','swing')
                    })
            });
            
            $('#checkBox_all').click(function(){
                if($('#checkBox_all').is(':checked'))
                    $(':regex(id,^(checkBox_))').attr('checked',true);
                else
                    $(':regex(id,^(checkBox_))').attr('checked',false);
            });
            
            
            //Adding behaviour to tab content
            $('#tabMenu li').click(function(){
                tab_id=$('#tabMenu li.active').attr('id')
                $('#'+tab_id+'_content').addClass('hidden');
                $('#tabMenu li.active').removeClass('active');
                
                tab_id=$(this).attr('id')
                $('#'+tab_id+'_content').removeClass('hidden');
                $(this).addClass('active');
            })
            
            // Menu desplegable "Listas"
            // Defino que submenus deben estar visibles cuando se pasa el mouse por encima            
            hiConfig = {
                sensitivity: 2, // number = sensitivity threshold (must be 1 or higher)
                interval: 0, // number = milliseconds for onMouseOver polling interval
                timeout: 500, // number = milliseconds delay before onMouseOut
                over: function() {
                    $(this).find('ul:first:hidden').css({visibility: "visible",display: "none"}).slideDown(400);
                },
                out: function() {
                     $(this).find('ul:first').slideUp(400);
                }
            }
            
            $(".mvBtn, .submenu ").hoverIntent(hiConfig);
            
            $('.submenu li').click(function(){submenuLiBehave(this)})
            
            //Enter behave when adding new list
            $("#new-list-btn span#new-list").keyup(function(e) {
                var suggestionList=[];
                e.preventDefault();
                //On press enter
                if(e.keyCode == 13) {

                    //Comprobamos si hay sugerencias seleccionadas para añadirlas
                    var checkedSuggestions=$('.suggestion input[type=checkbox]').filter(':checked');
                    if( checkedSuggestions.length>0){
                        checkedSuggestions.each(function(){
                            suggestionList.push($(this).attr('id').substring(9,$(this).attr('id').length))
                        })
                    }
                    
                    console.log(suggestionList)
                    
                    $.ajax({
                        type: "POST",
                        url: "{% url add_suggestion_list %}",
                        data: {
                            name: $(this).find('input').val(),
                            suggestions: suggestionList
                        },
                        dataType:'json',
                        success: function(data){
                            //Añadimos la lista al desplegable
                            $("<li id=\"listid-"+data.id+"\">"+data.name+" ("+data.keys.length+" sugerencias)</li>").insertBefore('#new-list-btn');
                            $('#listid-'+data.id).click(function(){submenuLiBehave(this)});
                            
                            //Añadimos a la lista de sugerencias las nuevas listas en que se encuentran
                            
                            //Mostrar mensaje de éxito
                        }
                    });
                    
                    $("#new-list-btn span#text").css('display','inline-block')
                    $("#new-list-btn span#new-list").css('display','none')
                    $("#new-list-btn span#new-list").find('input').val("");
                }
            });
            
            
            $('#new-list-btn').click(function(){
                if($("#new-list-btn span#text").css('display')=="inline-block"){
                    $("#new-list-btn span#text").css('display','none')
                    $("#new-list-btn span#new-list").css('display','inline-block')
                    $("#new-list-btn span#new-list").find('input').focus()
                }
            })
            
            
        });
        
        function submenuLiBehave(obj){
            if($(obj).attr('id')=="new-list-btn")
                return false;
            var addToList=$(obj).attr('id').substring(7,$(obj).attr('id').length);
            var suggestions=[]
            var checkedSuggestions=$('.suggestion input[type=checkbox]').filter(':checked');
            if( checkedSuggestions.length==0){
                console.log("No ha seleccionado items");
            }else{
                checkedSuggestions.each(function(){
                    //console.log("Añadimos a la lista: "+addToList+", la sugerencia: "+);
                    suggestions.push($(this).attr('id').substring(9,$(this).attr('id').length))
                });
                
                $.ajax({
                    type: "POST",
                    url: "{% url add_suggestion_list %}",
                    data: {
                        list_id: addToList,
                        suggestions: suggestions
                    },
                    dataType:'json',
                    success: function(data){
                        //Añadimos a la lista de sugerencias las nuevas listas en que se encuentran
                        console.log("Sugerencias añadidas con éxito");
                        //Mostrar mensaje de éxito
                    }
                });
            }
            
        }
        
        function toogleSuggestion(obj){
            var suggestion_id=$(obj).parent().attr('id').substr(11)
            var temp=$(obj).parent()
            console.log("Entro")
            
            temp.parent().find('div.expanded').toggle();
            temp.parent().find('div.collapsed').toggle();
        }
        function loadSuggestionsPage(page){
            GRM.loadPage({
                page:page,
                "total_pages":{{suggestions.2}},
                container:'#suggestion-list',
                url:'/ajax/get/suggestion/',
                template: "#suggestionTemplate",
                data:{
                        'query_id':{{suggestions.0}},
                    }                
            });
        }
        
        function removeSuggestions(){
            temp=$("input[name='suggestions']:checked")
            $.each(temp, function(index,value){
                $.ajax({
                    type: "POST",
                    url: "/ajax/delete/suggestion/",
                    data: {
                        eventid:value.value
                    },
                    complete: function(msg){
                        if (msg.status !=200){
                            $('#error-msg').text("Error "+msg.status)
                            $('#error-msg').fadeIn('slow').delay(2000).fadeOut('slow')
                        }else{
                            $('#suggestion_'+value.value).fadeOut('slow').remove()
                        }
                        
                    }
                });
            })
        }
        
        
    </script>
{%endblock%}

{% block goBack %}{%endblock%}
{% block body %}
    <div id="suggestions">
    
<!--
    Sugeridas={{user.counters}}
-->
        <h1>Baúl de sugerencias</h1>
        <ul id="tabMenu">
            <li id="your_suggestions" class="active">Tus sugerencias ({{user.counters.suggested}})</li>
            <li id="all_suggestions">Todas</li>
            <li id="suggestions_lists">Listas</li>
        </ul>
        <div id="content">
                <!-- YOUR SUGGESTIONS -->
                <span id="your_suggestions_content" class="tab-content">
                    <div id="header">
                        <span class="selectCheckBox"><input type="checkbox" id="checkBox_all" value="Car" /></span>
                        <span class="btn right nextBtn {% if user.counters.suggested < 11 %} hidden {% endif %}" id="next-page" onclick="loadSuggestionsPage('next')">Siguiente</span>
                        <span class="btn right prevBtn hidden" id="prev-page" onclick="javascript:loadSuggestionsPage('prev')">Anterior</span>
                        
                        <span class="btn removeBtn" onclick="removeSuggestions()">Eliminar</span>
                        <span class="btn mvBtn">
                            Listas
                            <ul class="submenu" style="display:none">
                                {% if lists %}
                                    {% for obj in lists %}
                                        <li id="{{obj.id}}">{{obj.name}} ({{obj.keys|length}} sugerencias)</li>
                                    {% endfor %}
                                {% endif %}
                                <li id="new-list-btn">
                                    <span id="text">Nueva lista...</span>
                                    <span id="new-list" style="display:none"><input type="text" /></span>
                                </li>
                            </ul>
                        </span>
                        
                    </div>
                    
                        <!-- Objetos Suggestion-->
                        {% if user.counters.suggested == 0 %}
                            <div id="noSuggestions" class="tab-content">
                                <span>
                                    Aún no has hecho ninguna sugerencia, para empezar:<br>
                                    <a href="{% url fb_add_suggestion %}" id="btn-add-suggestion">Añade una sugerencia</a>
                                </span>
                            </div>
                        {% else %}
                        <span id="suggestion-list" class="tab-content">
                            {% for k in suggestions.1%}
                                <div id="suggestion_{{k.id}}" class="suggestion">
                                    <div class="collapsed">
                                        <span class="checkBox"><input type="checkbox" id="checkBox_{{k.id}}" value="{{k.id}}" name="suggestions" /></span>
                                        <span class="suggestionName">{{k.name}}</span>
<!--
                                        <span class="suggestionInLists">
                                        Lista {{k.id}}</span>
-->
                                    </div>
                                    <div class="expanded" style="display:none">
                                        <dl>
                                            <dt>Nombre:</dt>
                                            <dd class="editable">{{k.name}}</dd>
                                            
                                            {% if k.description%}
                                                <dt>Descripción:</dt>
                                                <dd>{{k.description}}</dd>
                                            {% endif %}
                                            
                                            <dt>Lugar:</dt>
                                            <dd>
                                                <a class="placeName" href="">{{k.poi.name}}</a> ({{k.poi.address}}) 
                                                <a href="{% url fb_edit_suggestions k.id %}">Editar</a>
                                            </dd>
                                            
                                            {% if k.date_starts != None or k.date_ends != None%}
                                                <dt>Fecha:</dt>
                                            
                                                <dd class="editable">
                                                    {% if k.date_starts != None %}
                                                        {{k.date_starts}}
                                                    {% endif %}
                                                    {% if k.date_ends != None %}
                                                        {{k.date_ends}}
                                                    {% endif %}    
                                                </dd>
                                            
                                            {% endif %}
                                            
                                            <dt>Listas</dt>
                                            <dd>
                                                <ul>
                                                    <li id="lista1" class="removable">Lista 1</li>
                                                    <li id="lista2" class="removable">Lista 2</li>
                                                </ul>
                                            </dd>
                                            
                                            <dt>Fecha de la última modificación:</dt>
                                            <dd>{{k.modified}}</dd>
                                            
                                            <dt>Personas a las que les gusta: </dt>
                                            <dd>{{k.counters.followers}}</dd>
                                            
                                            <dt>Comentarios recibidos:</dt>
                                            <dd>{{k.counters.comments}}</dd>
                                        </dl>
                                        <div class="collapseBtn"><img src="/static/webapp/img/collapse.png"></div>
                                        
                                    </div>
                                    
                                </div>
                                
                                
                            {% endfor%}   
                        </span>           
                        {% endif %}
                    </span>
                    <!-- END YOUR SUGGESTIONS -->
                    
                    
                    
                    
                    <!-- ALL SUGGESTIONS -->
                    <span id="all_suggestions_content" class="tab-content hidden">
                        <p>Todas las sugerencias</p>
                    </span>
                    <!-- END ALL SUGGESTIONS -->
                    
                    <!-- ALL SUGGESTIONS -->
                    <span id="suggestions_lists_content" class="tab-content hidden">
                        <p>Listas de sugerencias</p>
                    </span>
                    <!-- END ALL SUGGESTIONS -->
            </table>
        </div>
    </div>
    
    
    <script id="suggestionTemplate" type="text/x-jquery-tmpl">
        <div id="suggestion_${element.id}" class="suggestion">
            <div class="collapsed">
                <span class="checkBox"><input type="checkbox" id="checkBox_{{element.id}}" value="${element.id}" /></span>
                <span class="suggestionName">${element.name}</span>
<!--
                <span class="suggestionInLists">Lista ${element.id}</span>
-->
            </div>
            <div class="expanded hidden">
                Id:${element.id}<br>
            </div>
        </div>
    </script>
{% endblock %}
