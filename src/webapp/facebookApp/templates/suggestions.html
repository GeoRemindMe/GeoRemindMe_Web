{% extends "base.html" %}

{% block title %}Tus sugerencias{% endblock %}

{% block extra_js %}
    <script src="/static/webapp/js/jquery.tmpl.min.js"></script>
    <script src="/static/facebookApp/js/grm.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
        jQuery.expr[':'].regex = function(elem, index, match) {
            var matchParams = match[3].split(','),
                validLabels = /^(data|css):/,
                attr = {
                    method: matchParams[0].match(validLabels) ?
                                matchParams[0].split(':')[0] : 'attr',
                    property: matchParams.shift().replace(validLabels,'')
                },
                regexFlags = 'ig',
                regex = new RegExp(matchParams.join('').replace(/^\s+|\s+$/g,''), regexFlags);
            return regex.test(jQuery(elem)[attr.method](attr.property));
        }
        
        $(document).ready(function(){
            
            //Asignamos comportamiento ONCLICK a cada fila
            $('.suggestionName').click(function(){
                if($(this).find('.checkBox')){
                    //Extraemos el ID de la sugerencia del campos id="" del div
                    var suggestion_id=$(this).parent().attr('id').substr(11)
                    location.href='edit/'+suggestion_id
                    //console.log('edit/'+suggestion_id)
                }
            });
            
            $('#checkBox_all').click(function(){
                if($('#checkBox_all').is(':checked'))
                    $(':regex(id,^(checkBox_))').attr('checked',true);
                else
                    $(':regex(id,^(checkBox_))').attr('checked',false);
            });
            
            
            //Adding behaviour to tab content
            $('#tabMenu li').click(function(){
                tab_id=$('#tabMenu li.active').attr('id')
                $('#'+tab_id+'_content').addClass('hidden');
                $('#tabMenu li.active').removeClass('active');
                
                tab_id=$(this).attr('id')
                $('#'+tab_id+'_content').removeClass('hidden');
                $(this).addClass('active');
            })
            
        });
        
        function loadSuggestionsPage(page){
            loadPage({
                page:page,
                container:'#suggestion-list',
                url:'/ajax/get/suggestion/',
                template: "#suggestionTemplate",
                data:{
                        'query_id':{{suggestions.0}},
                    }                
            });
        }
        
        
        function removeSuggestions(){
            temp=$("input[name='suggestions']:checked")
            $.each(temp, function(index,value){
                $.ajax({
                    type: "POST",
                    url: "/ajax/delete/suggestion/",
                    data: {
                        eventid:value.value
                    },
                    complete: function(msg){
                        if (msg.status !=200){
                            $('#error-msg').text("Error "+msg.status)
                            $('#error-msg').fadeIn('slow').delay(2000).fadeOut('slow')
                        }else{
                            $('#suggestion_'+value.value).fadeOut('slow').remove()
                        }
                        
                    }
                });
            })
        }
        
        
    </script>
{%endblock%}

{% block goBack %}{%endblock%}
{% block body %}
    <div id="suggestions">
    
<!--
    Sugeridas={{user.counters}}
-->
        <h1>Baúl de sugerencias</h1>
        <ul id="tabMenu">
            <li id="your_suggestions" class="active">Tus sugerencias ({{user.counters.suggested}})</li>
            <li id="all_suggestions">Todas</li>
            <li id="suggestions_lists">Listas</li>
        </ul>
        <div id="content">
                <!-- YOUR SUGGESTIONS -->
                <span id="your_suggestions_content" class="tab-content">
                    <div id="header">
                        <span class="selectCheckBox"><input type="checkbox" id="checkBox_all" value="Car" /></span>
                        <span class="btn right nextBtn {% if user.counters.suggested < 11 %} hidden {% endif %}" id="next-page" onclick="javascript:loadSuggestionsPage('next')">Siguiente</span>
                        <span class="btn right prevBtn hidden" id="prev-page" onclick="javascript:loadSuggestionsPage('prev')">Anterior</span>
                        
                        <span class="btn removeBtn" onclick="removeSuggestions()">Eliminar</span>
                        <span class="btn mvBtn">Mover a</span>
                        
                    </div>
                    
                        <!-- Objetos Suggestion-->
                        {% if user.counters.suggested == 0 %}
                            <div id="noSuggestions" class="tab-content">
                                <span>
                                    Aún no has hecho ninguna sugerencia, para empezar:<br>
                                    <a href="{% url fb_add_suggestion %}" id="btn-add-suggestion">Añade una sugerencia</a>
                                </span>
                            </div>
                        {% else %}
                        <span id="suggestion-list" class="tab-content">
                            {% for k in suggestions.1%}
                                <div id="suggestion_{{k.id}}" class="suggestion">
                                    <span class="checkBox"><input type="checkbox" id="checkBox_{{k.id}}" value="{{k.id}}" name="suggestions" /></span>
                                    <span class="suggestionName">{{k.name}}</span>
                                    <span class="suggestionInLists"><!-- Listas no implementadas -->Lista {{k.id}}</span>
                                </div>
                            {% endfor%}   
                        </span>           
                        {% endif %}
                    </span>
                    <!-- END YOUR SUGGESTIONS -->
                    
                    
                    
                    
                    <!-- ALL SUGGESTIONS -->
                    <span id="all_suggestions_content" class="tab-content hidden">
                        <p>Todas las sugerencias</p>
                    </span>
                    <!-- END ALL SUGGESTIONS -->
                    
                    <!-- ALL SUGGESTIONS -->
                    <span id="suggestions_lists_content" class="tab-content hidden">
                        <p>Listas de sugerencias</p>
                    </span>
                    <!-- END ALL SUGGESTIONS -->
            </table>
        </div>
    </div>
    
    <script id="collapsedSuggestion" type="text/x-jquery-tmpl">
        <span class="checkBox">${id}</span>
        <span class="suggestionName">${suggestion}</span>
        <span class="suggestionInLists">${lists}</span>
    </script>
    <script id="expandedSuggestion" type="text/x-jquery-tmpl">
        Sugieron que...
    </script>
    
    <script id="suggestionTemplate" type="text/x-jquery-tmpl">
        <div id="suggestion_${element.id}" class="suggestion">
            <span class="checkBox"><input type="checkbox" id="checkBox_{{element.id}}" value="${element.id}" /></span>
            <span class="suggestionName">${element.name}</span>
            <span class="suggestionInLists">Lista ${element.id}</span>
        </div>
    </script>
{% endblock %}
