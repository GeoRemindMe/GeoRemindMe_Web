{% extends "base.html" %}

{% block title %}Tu mochila de sugerencias{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="/static/webapp/js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="/static/facebookApp/js/grm.js"></script>
    <script type="text/javascript" src="/static/facebookApp/js/vault.js"></script>

    <script type="text/javascript" src="/static/webapp/js/jquery.jeditable.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="/static/facebookApp/js/jquery.hoverIntent.minified.js"></script>
    <script type="text/javascript" src="/static/webapp/js/jquery.placeholder.js"></script>
    <script type="text/javascript">        
        $(document).ready(function(){    
            //Asignamos comportamiento ONCLICK a cada fila --> Desplegar detalles
            setExpandible('.suggestion');
            
            $('#filter-suggestions').search('#suggestion-list > div',['.suggestionName_editable']);
            $('#filter-lists').search('#suggestion-list-lists > div',['.suggestionName_editable']);
            
            $('#checkBox_all').click(function(){
                if($('#checkBox_all').is(':checked'))
                    $(':regex(id,^(checkBox_))').attr('checked',true);
                else
                    $(':regex(id,^(checkBox_))').attr('checked',false);
            });
            
            //$('.editable').editable({editBy:"dblclick"});
            
            $('.editable[value="textarea"]').editable('suggestions/add', { 
                 type      : 'textarea',
                 cancel    : 'Cancel',
                 submit    : 'OK',
                 indicator : 'Saving...',
                 tooltip   : 'Click to edit...'
             });
            $('.editable:not([value="textarea"])').editable('suggestions/add', { 
                 type      : 'text',
                 cancel    : 'Cancel',
                 submit    : 'OK',
                 indicator : 'Saving...',
                 tooltip   : 'Click to edit...'
             });
            
            $('.empty-msg').parent().find('ul').each(function(i,elem){
                if($(elem).children().length==0){
                    $(elem).hide();
                    $(elem).parent().find('.empty-msg').show();
                }else{
                    $(elem).parent().find('.empty-msg').hide();
                }
            })

            
            //Adding behaviour to tab content
            $('#tabMenu li').click(function(){
                tab_id=$('#tabMenu li.active').attr('id')
                $('#'+tab_id+'_content').addClass('hidden');
                $('#tabMenu li.active').removeClass('active');
                
                tab_id=$(this).attr('id')
                $('#'+tab_id+'_content').removeClass('hidden');
                $(this).addClass('active');
            })
            
            // Menu desplegable "Listas"
            // Defino que submenus deben estar visibles cuando se pasa el mouse por encima            
            hiConfig = {
                sensitivity: 2, // number = sensitivity threshold (must be 1 or higher)
                interval: 0, // number = milliseconds for onMouseOver polling interval
                timeout: 500, // number = milliseconds delay before onMouseOut
                over: function() {
                    $(this).find('ul:first:hidden').css({visibility: "visible",display: "none"}).slideDown(400);
                },
                out: function() {
                    if($("#dropdown-list").hasClass('visible-display')==false)
                        $(this).find('ul:first').slideUp(400);
                }
            }
            
            $(".dropDrownBtn, .submenu ").hoverIntent(hiConfig);
            $(".dropDrownBtn").click(function(){
                $(this).find('ul:first:hidden').css({visibility: "visible",display: "none"}).slideDown(400);
            })
            
            $('.submenu li').click(function(){submenuLiBehave(this)})
            
            //Enter behave when adding new list on Suggestions Tab
            $("#new-list-btn span#new-list").keyup(function(e) {
                var suggestionList=[];
                e.preventDefault();
                if (e.which == 27){
                    //On press escape
                    closeDropdown();
                }else if(e.keyCode == 13) {
                    //On press enter
                    //Comprobamos si hay sugerencias seleccionadas para añadirlas
                    var checkedSuggestions=$('.suggestion input[type=checkbox]').filter(':checked');
                    if( checkedSuggestions.length>0){
                        checkedSuggestions.each(function(){
                            suggestionList.push($(this).attr('id').substring(9,$(this).attr('id').length))
                        })
                    }
                    
                    $.ajax({
                        type: "POST",
                        url: "{% url modify_suggestion_list %}",
                        data: {
                            name: $(this).find('input').val(),
                            suggestions: suggestionList
                        },
                        dataType:'json',
                        success: function(data){
                            //Añadimos la lista al desplegable
                            $("<li id=\"listid-"+data.id+"\">"+data.name+" (<span class=\"list-"+data.id+"-counter\">"+data.keys.length+"</span> sugerencias)</li>").insertBefore('#new-list-btn');
                            $('#listid-'+data.id).click(function(){submenuLiBehave(this)});
                            
                            //Añadimos la lista en la pestaña listas
                            
                            //Reordenamos alfabéticamente la lista desplegable
                            $('.submenu li').not('li#new-list-btn').sortElements(function(a, b){
                                return $(a).text().toLowerCase() > $(b).text().toLowerCase() ? 1 : -1;
                            });
                            
                            $("#dropdown-list").removeClass('visible-display');
                            
                            //Añadimos a la sugerencia dentro de la lista de sugerencias 
                            //las nuevas listas en las que se encuentra
                            updateSuggestions(data);
                            
                            //Actualizamos el contador de la lista con el número de sugerencias
                            updateCounter(data.id,data.keys.length);
                            
                            //Añadimos la lista a la pestaña listas
                            var suggestions=[];
                            $(data.keys).each(function(){
                                suggestions.push({
                                        id:this,
                                        name:$('#suggestion_'+this+' .suggestionName_editable').text()
                                    })
                            })
                            var obj=$("#listTemplate").tmpl({obj:data, keys:suggestions}).appendTo("#suggestion-list-lists");
                            if(obj.find('.suggestions ul li').length > 0){
                                tmp=obj;
                                obj.find('.suggestions ul').show();
                                obj.find('.suggestions .empty-msg').hide();
                                obj.find('.suggestions li.removable').click(function(){
                                    var unparsedString=$(this).attr('class').split(" ")[0];
                                    var listID = unparsedString.substring(5,unparsedString.length)
                                    removeFromList(this,listID);
                                });
                            }
                            
                            
                            setExpandible('#list_'+data.id);
                            
                            //Aumentamos el contador de las listas
                            $('#lists-tab-counter').text(parseInt($('#lists-tab-counter').text())+1);
                            
                            //Mostrar mensaje de éxito
                            showMessage("La lista ha sido añadida con éxito","success")
                            
                            
                        }
                    });
                    
                    $("#new-list-btn span#text").css('display','inline-block')
                    $("#new-list-btn span#new-list").css('display','none')
                    $("#new-list-btn div#cancel-link").css('display','none')
                    $("#new-list-btn span#new-list").find('input').val("");
                }                
            });
            
            //Reordenamos alfabéticamente la lista desplegable
            $('.submenu li').not('li#new-list-btn').sortElements(function(a, b){
                return $(a).text().toLowerCase() > $(b).text().toLowerCase() ? 1 : -1;
            });
            
            //On expanded view of a suggestion--> Remove suggestion from a list
            $('.removable-sugestion-list li').click(function(){
                var unparsedString=$(this).attr('class').split(" ")[0];
                var listID = unparsedString.substring(5,unparsedString.length)
                removeFromList(this,listID);
            });
            
            $('#suggestion-list-lists .suggestions li.removable').click(function(){
                var unparsedString=$(this).attr('class').split(" ")[0];
                var listID = unparsedString.substring(5,unparsedString.length)
                removeFromList(this,listID);
            });
            
            
            //On LISTS tab, add new list
            $('.addNewList').click(function(){
               console.log("Añadimos nueva lista") 
            });
            
            $('#new-list-btn span#text').click(function(){                
                $("#new-list-btn span#text").css('display','none')
                $("#new-list-btn span#new-list").css('display','inline-block')
                $("#new-list-btn span#new-list").find('input').focus()
                $("#new-list-btn div#cancel-link").css('display','block')
                $("#dropdown-list").addClass('visible-display');
            })
            
            
            $('.empty-msg').click(function(){
                $("#checkBox_"+$(this).attr('value')).attr('checked',true);
                $(".dropDrownBtn").click()
            });
            
            
            $('.show-more').click(function (){
                var textElement=$(this).parent().find('.show-more-text');
                if($(textElement).css('display')!="none")
                    $(this).html("Mostrar estadísticas")
                else
                    $(this).html("Ocultar estadísticas")
                
                $(textElement).toggle('slow')
            });
            
            $("[placeholder]").placeholder();
            
            $('#filterMySuggestions').toggle(function(){
                $(this).addClass('pressed');
                $('#suggestion-list .not-mine').fadeOut('slow');
            },function(){
                $(this).removeClass('pressed');
                $('#suggestion-list .not-mine').fadeIn('slow');
            });
            
            $('#filterMyLists').toggle(function(){
                $(this).addClass('pressed');
                $('#suggestion-list .not-mine').fadeOut('slow');
            },function(){
                $(this).removeClass('pressed');
                $('#suggestion-list-lists .not-mine').fadeIn('slow');
            });
            
        });//END $(document).ready

        /*
         * 
         * 
         * 
         */

        
        // Actualizamos la información de en que listas se encuentra
        // cada una de la sugerencias del grid
        function updateSuggestions(data){
            asd=data;
            var suggestions = data.keys;
            var listID = data.id;
            var listName = data.name;
            
            $(suggestions).each(function(i,suggestionID){
                /** SUGGESTIONS TAB **/
                //Comprobamos si ya aparece en el DOM de la sugerencia, la lista de sugerencias
                if($('#suggestion_'+suggestionID+' .removable-sugestion-list .list_'+listID).length==0){
                    //Si no existe creamos el elemento y le damos el comportamiento de edición/borrado
                    var tmp='<li class="list_'+listID+' removable" value="'+suggestionID+'">'+listName+'</li>';
                    $('#suggestion_'+suggestionID+' .removable-sugestion-list ').append(tmp);
                    var element=$('#suggestion_'+suggestionID+' .removable-sugestion-list .list_'+listID);
                    element.click(function(){
                        var unparsedString=$(this).attr('class').split(" ")[0];
                        var listID = unparsedString.substring(5,unparsedString.length)
                        removeFromList(this,listID);
                    });
                    
                    //Si se mostraba en el mensaje de vacío lo borramos
                    console.log(suggestionID);
                    console.log(element);
                    if(element.parent().css('display')=="none"){
                        element.parent().show();
                        element.parent().parent().find('.empty-msg').hide();
                    }
                }
                
                /** LISTS TAB **/
                //Comprobamos si en la lista ya existe la sugerencia
                if ($('#list_'+listID+' .suggestions li[value="'+suggestionID+'"]').length==0){
                    //Si no está la sugerencia en la lista la añadimos
                    $('#list_'+listID+' .suggestions ul').append('<li value="'+suggestionID+'" class="list_'+listID+' removable">'+$('#suggestion_'+suggestionID+' .suggestionName_editable').text()+'</li>');
                    
                    $('#list_'+listID+' .suggestions ul li[value="'+suggestionID+'"]').click(function(){
                        var unparsedString=$(this).attr('class').split(" ")[0];
                        var listID = unparsedString.substring(5,unparsedString.length)
                        removeFromList(this,listID);
                    });
                    
                    if($('#list_'+listID+' .suggestions ul li').length==1){
						$('#list_'+listID+' .suggestions ul').show();
						$('#list_'+listID+' .suggestions .empty-msg').hide();
						
					}
                }
            })
            
            
        }

        //Extrae a una sugerencia de una lista
        function removeFromList(obj,listID){
            
            suggestionID = $(obj).attr('value')
            domElement=$(obj);
            
            //console.log("Eliminamos sugerencia "+suggestionID+" de la lista " + listID)
            
            $.ajax({
                type: "POST",
                url: "{% url modify_suggestion_list %}",
                data: {
                    list_id: listID,
                    suggestions_del: [suggestionID]
                },
                dataType:'json',
                success: function(data){

                    
                    //Ocultamos el objeto y eliminamos
                    domElement.fadeOut(function(){ 
                        if($('#suggestion_'+suggestionID+' .removable-sugestion-list li').length==1){
                            //Mostramos el mensaje de que no quedan más
                            $('#suggestion_'+suggestionID+' .empty-msg').fadeIn('slow');
                        }
                        
                        if($(obj).parent().children().length==1){
                            //console.log("Ya no quedan más hermanos");
                            $(obj).parent().parent().find('.empty-msg').show()
                        }
                        $(obj).remove();
                        
                        //Actualizamos el contador de la lista
                        updateCounter(listID,data.keys.length);
                    })
                    
                    //Buscamos en la pestaña opuesta
                    if($('#suggestions_lists').hasClass('active')){
						//Borramos del detalle de sugerencia la lista
						if($('#suggestion_'+suggestionID+' ul.removable-sugestion-list li').length==1){
                            //Ya no quedan más hermanos en la pestaña detalle de sugerencia
                            $('#suggestion_'+suggestionID+' .empty-msg').show()
                        }
						$('#suggestion_'+suggestionID+' .list_'+listID).remove()
					}else{
						//Borramos del detalle de lista la sugerencia
						if($('#list_'+listID+' dd.suggestions li').length==1){
                            //Ya no quedan más hermanos en la pestaña detalle de sugerencia
                            $('#list_'+listID+' dd.suggestions .empty-msg').show()
                        }
						$('#list_'+listID+' li[value="'+suggestionID+'"]').remove()
						
					}
                    
                    showMessage("La sugerencia ha sido eliminada de la lista correctamente","success")

                    
                }
            });
        }

        //Añade las sugerencias marcadas a la lista correspondiente
        function submenuLiBehave(obj){
            if($(obj).attr('id')=="new-list-btn")
                return false;
            var addToList=$(obj).attr('id').substring(7,$(obj).attr('id').length);
            var suggestions=[]
            var checkedSuggestions=$('.suggestion input[type=checkbox]').filter(':checked');
            if( checkedSuggestions.length==0){
                showMessage("No hay ninguna sugerencia seleccionada","error")
            }else{
                checkedSuggestions.each(function(){
                    //console.log("Añadimos a la lista: "+addToList+", la sugerencia: "+);
                    suggestions.push($(this).attr('id').substring(9,$(this).attr('id').length))
                });
                
                $.ajax({
                    type: "POST",
                    url: "{% url modify_suggestion_list %}",
                    data: {
                        list_id: addToList,
                        suggestions: suggestions
                    },
                    dataType:'json',
                    success: function(data){
                        
                        //Añadimos a la sugerencia dentro de la lista de sugerencias 
                        //las nuevas listas en las que se encuentra
                        updateSuggestions(data);
                        
                        
                        //Actualizamos el contador de la lista
                        updateCounter(data.id,data.keys.length);
                        
                        //Mostrar mensaje de éxito
                        showMessage("Las sugerencias han sido añadidas a la lista","success")
                    }
                });
            }
            
        }
        
        function closeDropdown(){
            $("#dropdown-list").removeClass('visible-display');
            $("#new-list-btn span#text").css('display','inline-block');
            $("#new-list-btn span#new-list").css('display','none');
            $("#new-list-btn div#cancel-link").css('display','none');
            $("#new-list-btn span#new-list").find('input').val("");
        }

        function toogleSuggestion(obj){
            var suggestion_id=$(obj).parent().attr('id').substr(11)
            var temp=$(obj).parent()
            
            temp.parent().find('div.expanded').toggle();
            temp.parent().find('div.collapsed').toggle();
        }


        function loadSuggestionsPage(page){
            GRM.loadPage({
                page:page,
                "total_pages":{{suggestions.2}},
                container:'#suggestion-list',
                url:'/ajax/get/suggestion/',
                template: "#suggestionTemplate",
                data:{
                        'query_id':"{{suggestions.0}}",
                    }                
            });
        }

        function setExpandible(obj){
            $(obj+' .maximize-minimize').toggle(function(){
                    $(this).parent().find('div.expanded').slideDown('fast');
                    $(this).parent().find('.suggestionName').toggle();
                    $(this).parent().find('.suggestionName_editable').toggle();
                    $(this).removeClass('suggestionCollapsed');
                    $(this).addClass('suggestionExpanded');
                },function() {
                    $(this).parent().find('div.expanded').slideUp('fast'); 
                    $(this).parent().find('.suggestionName').toggle();
                    $(this).parent().find('.suggestionName_editable').toggle();
                    $(this).removeClass('suggestionExpanded');
                    $(this).addClass('suggestionCollapsed');
            });
            
            //Copiamos el comportamiento del click sobre el botón al hacerlo
            //sobre el nombre de la sugenrecia
            $(obj+' .suggestionName').click(function(){
                $(this).parentsUntil('.suggestion').parent().find('.maximize-minimize').click();
            })
            $(obj+' .suggestionName_editable').click(function(){
				$(this).parentsUntil('.suggestion,.suggestionList').parent().find('.maximize-minimize').click();
            })
        }

        function removeSuggestions(){
            temp=$("input[name='suggestions']:checked")
            $.each(temp, function(index,value){
                $.ajax({
                    type: "POST",
                    url: "/ajax/delete/suggestion/",
                    data: {
                        eventid:value.value
                    },
                    complete: function(msg){
                        if (msg.status !=200){
                            showMessage("Error: "+msg.status,"error")
                        }else{
                            $('#suggestion_'+value.value).fadeOut('slow').remove()
                            showMessage("Las sugerencias han sido eliminadas con éxito","success")
                            //Disminuimos el contador
                            $('#suggestions-tab-counter').text(parseInt($('#suggestions-tab-counter').text())-1);
                        }
                        
                    }
                });
            })
        }
        function removeLists(){
            temp=$("input[name='lists']:checked")
            $.each(temp, function(index,value){
                $.ajax({
                    type: "POST",
                    url: "/ajax/delete/suggestion/list/",
                    data: {
                        list_id: value.value
                    },
                    complete: function(msg){
                        if (msg.status !=200){
                            showMessage("Error: "+msg.status,"error")
                        }else{
                            $('#list_'+value.value).fadeOut('slow').remove()
                            showMessage("Las listas han sido eliminadas con éxito","success")
                            //Disminuimos el contador
                            $('#lists-tab-counter').text(parseInt($('#lists-tab-counter').text())-1);
                            
                            //La borramos del desplegable
                            $('#dropdown-list #listid-'+value.value).remove();
                            
                            //Y del detalle de sugerencia
                            $('.list_'+value.value).remove()
                            
                        }
                        
                    }
                });
            })
        }
        
        //Actualiza el contador de la lista: listID y le pone el valor Val
        function updateCounter(listID,val){
            counterClass='.list-'+listID+'-counter';
            $(counterClass).text(val);
        }

        /**
         * jQuery.fn.sortElements
         * --------------
         * @param Function comparator:
         *   Exactly the same behaviour as [1,2,3].sort(comparator)
         *   
         * @param Function getSortable
         *   A function that should return the element that is
         *   to be sorted. The comparator will run on the
         *   current collection, but you may want the actual
         *   resulting sort to occur on a parent or another
         *   associated element.
         *   
         *   E.g. $('td').sortElements(comparator, function(){
         *      return this.parentNode; 
         *   })
         *   
         *   The <td>'s parent (<tr>) will be sorted instead
         *   of the <td> itself.
         */
        jQuery.fn.sortElements = (function(){
         
            var sort = [].sort;
         
            return function(comparator, getSortable) {
         
                getSortable = getSortable || function(){return this;};
         
                var placements = this.map(function(){
         
                    var sortElement = getSortable.call(this),
                        parentNode = sortElement.parentNode,
         
                        // Since the element itself will change position, we have
                        // to have some way of storing its original position in
                        // the DOM. The easiest way is to have a 'flag' node:
                        nextSibling = parentNode.insertBefore(
                            document.createTextNode(''),
                            sortElement.nextSibling
                        );
         
                    return function() {
         
                        if (parentNode === this) {
                            throw new Error(
                                "You can't sort elements if any one is a descendant of another."
                            );
                        }
         
                        // Insert before flag:
                        parentNode.insertBefore(this, nextSibling);
                        // Remove flag:
                        parentNode.removeChild(nextSibling);
         
                    };
         
                });
         
                return sort.call(this, comparator).each(function(i){
                    placements[i].call(getSortable.call(this));
                });
         
            };
         
        })();        
    </script>
{%endblock%}

{% block goBack %}{%endblock%}
{% block body %}
    <div id="suggestions">
<!--
    Sugeridas={{user.counters}}
-->
        <h1>Tu mochila</h1>
        <ul id="tabMenu">
            <li id="your_suggestions" class="active">Sugerencias (<span id="suggestions-tab-counter">{{suggestions.1|length}}</span>)</li>
            <li id="suggestions_lists">Listas (<span id="lists-tab-counter">{{lists|length}}</span>)</li>
        </ul>
        <div id="content">
                <!-- YOUR SUGGESTIONS -->
                <span id="your_suggestions_content" class="tab-content">
                    <div id="header">
                        <span class="selectCheckBox"><input type="checkbox" id="checkBox_all" /></span>
<!--
                        <span class="btn right nextBtn {% if user.counters.suggested < 11 %} hidden {% endif %}" id="next-page" onclick="loadSuggestionsPage('next')">Siguiente</span>
                        <span class="btn right prevBtn hidden" id="prev-page" onclick="javascript:loadSuggestionsPage('prev')">Anterior</span>
-->
                        
                        <span class="btn removeBtn" onclick="removeSuggestions()">Eliminar</span>
                        <span class="btn dropDrownBtn">
                            Guardar en
                            <ul class="submenu" style="display:none" id="dropdown-list">
                                {% if lists %}
                                    {% for obj in lists %}
                                        {% if obj.user.username = request.user.username %}
                                            <!-- Solo se muestran mis listas -->
                                            <li id="listid-{{obj.id}}">{{obj.name}} (<span class="list-{{obj.id}}-counter">{{obj.keys|length}}</span> sugerencias)</li>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <li id="new-list-btn">
                                    <span id="text">Nueva lista...</span>
                                    <span id="new-list" style="display:none"><input type="text" /></span><div id="cancel-link" onclick="closeDropdown()" style="display:none">Cancel</div>
                                </li>
                            </ul>
                        </span>
                        
                        <span class="btn removeBtn filter"><input type="text" id="filter-suggestions" placeholder="Filtrar por nombre"></span>
                        <span class="btn removeBtn" id="filterMySuggestions">Mis sugerencias</span>
                    </div>
                    
                    <!-- Objetos Suggestion-->
                    {% if user.counters.suggested = 0 and suggestions_following|length = 0 %}
                        <div id="noSuggestions" class="tab-content">
                            <span>
                                Aún no has hecho ninguna sugerencia, para empezar:<br>
                                <a href="{% url fb_add_suggestion %}" id="btn-add-suggestion">Añade una sugerencia</a>
                            </span>
                        </div>
                    {% else %}
                    <span id="suggestion-list" class="tab-content">
                        {% for k in suggestions.1%}
                            <div id="suggestion_{{k.id}}" class="suggestion{% if k.user.username != user.username%} not-mine{%endif%}">
                                <div class="maximize-minimize suggestionCollapsed"><span>.</span></div>
                                <div class="collapsed">
                                    <span class="checkBox"><input type="checkbox" id="checkBox_{{k.id}}" value="{{k.id}}" name="suggestions" /></span>
                                    <span class="suggestionName">{{k.name}}{% if k.user.username != user.username%} (<em>{{k.user.username}}</em>){% endif %}</span>
                                    <span class="suggestionName_editable {% if k.user.username == user.username%}editable{% endif %}" style="display:none">{{k.name}}</span>
                                </div>
                                <div class="expanded" style="display:none">
                                    <dl>                                        
                                        {%if k.description or not k.user.username != user.username %}
                                        <dt>Descripción:</dt>
                                        <dd class=" {% if k.user.username == user.username%}editable{% endif %}" value="textarea">
                                            {%if k.description %}{{k.description}} {% else %}<em>Sin descripción</em>{% endif %}
                                            
                                        </dd>
                                        {%endif%}
                                        
                                        <dt>Lugar:</dt>
                                        <dd style="width:390px">
                                            <a class="placeName" href="{% url fb_view_place k.poi.slug%}">{{k.poi.name}}</a> ({{k.poi.address}}) 
                                             {% if k.user.username == user.username%}<a href="{% url fb_edit_suggestions k.id %}">Editar</a>{% endif %}
                                        </dd>
                                        
                                        <dt>Tags:</dt>
                                            <dd style="width:390px">
                                                <ul {% if k.user.username == user.username%}class="removable-tag-list"{%endif%} {% if k.tags|length = 0 %}style="display:none"{% endif %}>
                                                    {% for tag in k.tags %}
                                                        <li class="tag_{{tag}} {% if k.user.username == user.username%}removable{% endif %}" value="{{k.id}}">{{tag}}</li>
                                                    {% endfor %}
                                                </ul>
                                                
                                                <em  class="empty-msg {% if k.user.username == user.username%}editable{% endif %}" value="{{k.id}}">
                                                    Esta lista no tiene tags
                                                </em>
                                                
                                            </dd>
                                            
                                        {%if k.date_starts or k.date_ends or k.user.username == user.username %}
                                            <dt>Fecha:</dt>
                                            {% if k.date_starts != None or k.date_ends != None%}
                                                <dd class="{% if k.user.username == user.username%}editable{% endif %}">
                                                    {% if k.date_starts != None %}
                                                        {{k.date_starts}}
                                                    {% endif %}
                                                    {% if k.date_ends != None %}
                                                        {{k.date_ends}}
                                                    {% endif %}    
                                                </dd>
                                            {% endif %}
                                            <dd class="{% if k.user.username == user.username%}editable{% endif %}">
                                                <em>Sin fecha</em>
                                            </dd>
                                        {% endif %}
                                        
                                        
                                        <dt>Mis listas:</dt>
                                        <dd style="width:390px">
                                                <ul class="removable-sugestion-list" {% if k.lists|length = 0 %}style="display:none"{% endif %}>
                                                    {% for obj in k.lists %}
                                                        {% if obj.user.username = request.user.username %}
                                                            <li class="list_{{obj.id}} {% if k.user.username == user.username%}removable{% endif %}" value="{{k.id}}">{{obj.name}}</li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            
                                                
                                                <em class="empty-msg" value="{{k.id}}">
                                                    Haz clic aquí para añadir a una lista
                                                </em>
                                            
                                        </dd>
                                        
                                        <dt><strong>Compartir:</strong></dt>
                                        <dd>
                                            <ul class="share-suggestion">
                                                <li><a class="share-suggestion link-icon" href="{{ k.get_absolute_fburl }}">Enlace</a></li>
<!--
                                                <li><a class="share-suggestion georemindme-icon" href="">Sugerir a amigos</a></li>
-->
                                                <li><a class="share-suggestion twitter-icon" href="">Twitter</a></li>
                                                <li><a class="share-suggestion facebook-icon" href="">Muro</a></li>
                                            </ul>
                                        </dd>

                                        <dt>Autor:</dt>
                                        <dd><a href="{% url fb_public_profile k.user.username %}">{{k.user.username}}</a></dd>
                                        
                                    </dl>
                                    
                                    
			
                                    <div class="show-more-text" style="display:none">
                                        <p class="big statistics">Estadísticas:</p>
                                        <dl>
                                            
                                            <dt>Valoraciones recibidas: </dt>
                                            <dd>{{k.counters.votes}}</dd>
                                            
                                            <dt>Personas que han guardado la sugerencia: </dt>
                                            <dd>{{k.counters.followers}}</dd>
                                            
                                            <dt>Comentarios recibidos:</dt>
                                            <dd>{{k.counters.comments}}</dd>
                                            
                                            <dt>Última modificación:</dt>
                                            <dd>{{k.modified}}</dd>
                                        </dl>
                                    </div>
                                    <span class="show-more">Mostrar estadísticas</span>
                                    
                                </div>
                                
                            </div>
                            
                            
                        {% endfor%}   
                    </span>           
                    {% endif %}
                </span>
                <!-- END YOUR SUGGESTIONS -->
                    
                    
                    
               
                
                
                
                <!-- LISTS -->
                <span id="suggestions_lists_content" class="tab-content hidden">
                    <div id="header">
                        <span class="selectCheckBox"><input type="checkbox" id="checkBox_all" /></span>
                        <span class="btn right nextBtn {% if user.counters.suggested < 11 %} hidden {% endif %}" id="next-page" onclick="loadSuggestionsPage('next')">Siguiente</span>
                        <span class="btn right prevBtn hidden" id="prev-page" onclick="javascript:loadSuggestionsPage('prev')">Anterior</span>
                        
                        <span class="btn removeBtn" onclick="removeLists()">Eliminar</span>
<!--
                        <span class="btn addNewList">
                            Nueva lista
                        </span>
-->
                        <span class="btn removeBtn filter"><input type="text" id="filter-lists" placeholder="Filtrar por nombre"></span>
                        <span class="btn removeBtn" id="filterMyLists">Mis listas</span>                    
                    </div>

                    
                        <div id="suggestion-list-lists">
                        {% if lists %}
                            {% for obj in lists %}
                                <div id="list_{{obj.id}}" class="suggestion suggestionList{% if k.user.username != user.username%} not-mine{%endif%}">
                                    <div class="maximize-minimize suggestionCollapsed"><span>.</span></div>
                                    <div class="collapsed">
                                        <span class="checkBox"><input type="checkbox" id="checkBox_{{obj.id}}" value="{{obj.id}}" name="lists" /></span>
                                        <span class="suggestionName">{{obj.name}} (<span class="list-{{obj.id}}-counter">{{obj.count}}</span> sugerencias, autor: {{obj.user.username}} )</span>
                                        <span class="suggestionName_editable {% if k.user.username == user.username%}editable{% endif %}" style="display:none">{{obj.name}}</span>                                        
                                    </div>
                                    <div class="expanded" style="display:none">
                                        <dl>
                                            <dt>Descripción:</dt>
                                            <dd class="{% if k.user.username == user.username%}editable{% endif %}">{{obj.description}}</dd>
                                            
                                            <dt>Sugerencias</dt>
                                            <dd class="suggestions">
                                                
                                                <ul class="removable-suggestions-in-lists" {% if obj.instances|length = 0 %} style="display:none" {%endif%}>
                                                    {% for k in obj.instances %}
                                                        <li  class="list_{{obj.id}} {% if obj.user.username == user.username%}removable{% endif %}" value="{{k.id}}">{{k}}</li>
                                                    {% endfor %}
                                                </ul>
                                                
                                                <em class="empty-msg {% if k.user.username == user.username%}editable{% endif %}" value="{{k.id}}" {% if obj.instances|length > 0 %} style="display:none" {%endif%}>
                                                    No hay sugerencias en esta lista
                                                </em>
                                                
                                            </dd>
                                            
                                            <dt>Tags:</dt>
                                            <dd>
                                                {% if obj.tags %}
                                                    {{obj.tags}}
                                                {% else %}
                                                    <em>Esta lista no tiene tags</em>
                                                {% endif %}
                                            </dd>
                                            <dt><strong>Compartir:</strong></dt>
                                            <dd>
                                                <ul class="share-suggestion">
                                                    <li><a class="share-suggestion link-icon" href="{% url fb_view_suggestion k.id %}">Enlace</a></li>
                                                    <li><a class="share-suggestion georemindme-icon" href="">Sugerir a amigos</a></li>
                                                    <li><a class="share-suggestion twitter-icon" href="">Twitter</a></li>
                                                    <li><a class="share-suggestion facebook-icon" href="">Muro</a></li>
                                                </ul>
                                            </dd>
                                            <dt>Autor:</dt>
                                            <dd><a href="{% url fb_public_profile obj.user.username %}">{{obj.user.username}}</a></dd>
                                        </dl>
                                        
                                        <p class="big statistics">Estadísticas:</p>
                                        <dl>
                                            
                                            <dt>Personas que han guardado la lista: </dt>
                                            <dd>{{obj.counters.followers}}</dd>
                                            
                                            <dt>Comentarios recibidos:</dt>
                                            <dd>{{obj.counters.comments}}</dd>
                                            
                                            <dt>Última modificación:</dt>
                                            <dd>{{obj.modified}}</dd>
                                        </dl>
                                    </div>
                                </div>
                            {% endfor %}
						{% endif %}
                        </div>
                    
                </span>
                <!-- END LISTS -->
            </table>
        </div>
    </div>
    
    
    <script id="suggestionTemplate" type="text/x-jquery-tmpl">
        <div id="suggestion_${element.id}" class="suggestion">
            <div class="collapsed">
                <span class="checkBox"><input type="checkbox" id="checkBox_{{element.id}}" value="${element.id}" /></span>
                <span class="suggestionName">${element.name}</span>
<!--
                <span class="suggestionInLists">Lista ${element.id}</span>
-->
            </div>
            <div class="expanded hidden">
                Id:${element.id}<br>
            </div>
        </div>
    </script>
    
    
    <script id="listTemplate" type="text/x-jquery-tmpl">
        <div id="list_${obj.id}" class="suggestion suggestionList">
            <div class="maximize-minimize suggestionCollapsed"><span>.</span></div>
            <div class="collapsed">
                <span class="checkBox"><input type="checkbox" id="checkBox_${obj.id}" value="${obj.id}" name="lists" /></span>
                <span class="suggestionName">${obj.name} (<span class="list-${obj.id}-counter">${obj.count}</span> sugerencias, autor: ${obj.user.username} )</span>
                <span class="suggestionName_editable editable" style="display:none">${obj.name}</span>                                        
            </div>
            <div class="expanded" style="display:none">
                <dl>
                    <dt>Descripción:</dt>
                    <dd class="editable">Sin descripción</dd>
                    
                    <dt>Sugerencias</dt>
                    <dd class="suggestions">
                        
                        <ul style="display:none">
                            {% templatetag openvariable %}each keys{% templatetag closevariable %}
                                <li  class="list_${obj.id} removable" value="${$value.id}">${$value.name}</li>
                            {% templatetag openvariable %}/each{% templatetag closevariable %}
                        </ul>
                        
                        <em class="empty-msg editable" value="nothing">
                            No hay sugerencias en esta lista
                        </em>
                        
                    </dd>
                    
                    <dt>Tags:</dt>
                    <dd>
<!--
                        {% if obj.tags %}
                            {% templatetag openvariable %}obj.tags{% templatetag closevariable %}
                        {% else %}
                            <em>Esta lista no tiene tags</em>
                        {% endif %}
-->
                    </dd>
                    <dt><strong>Compartir:</strong></dt>
                    <dd>
                        <ul class="share-suggestion">
                            <li><a class="share-suggestion link-icon" href="{% url fb_view_suggestion k.id %}">Enlace</a></li>
                            <li><a class="share-suggestion georemindme-icon" href="">Sugerir a amigos</a></li>
                            <li><a class="share-suggestion twitter-icon" href="">Twitter</a></li>
                            <li><a class="share-suggestion facebook-icon" href="">Muro</a></li>
                        </ul>
                    </dd>
                    <dt>Autor:</dt>
                    <dd><a href="{% url fb_public_profile obj.user.username %}">${obj.user.username}</a></dd>
                </dl>
                
                <p class="big statistics">Estadísticas:</p>
                <dl>
                    
                    <dt>Personas que han guardado la lista: </dt>
                    <dd>${obj.counters.followers}</dd>
                    
                    <dt>Comentarios recibidos:</dt>
                    <dd>${obj.counters.comments}</dd>
                    
                    <dt>Última modificación:</dt>
                    <dd>${obj.modified}</dd>
                </dl>
            </div>
        </div>
    </script>
    
{% endblock %}
