{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% block extra_js %}

    <script src="/static/webapp/js/jquery.tmpl.min.js"></script>
    <script src="/static/facebookApp/js/grm.js"></script>
    <script src="/static/facebookApp/js/social.js"></script>
    
    <script type="text/javascript">
    
        $(document).ready(function(){
            resizeIframe();
            $(".like-dislike").like();
            
            initRemovable();

            $('.show-all-comments').click(function(){
                //Después de mostrar los comentarios ocultamos el botón
                $(this).parent().find('.long-list').slideDown('fast', function(){
                    resizeIframe();
                    $(this).parentsUntil('.suggestion-element').parent().find('.show-all-comments').remove();
                    
                });
                
            });


            //Al pulsar en comentar ponemos el foco en el input
            $('.focusInput').click(function(){
                var commentBox=$(this).parentsUntil('.suggestion-element').parent().find('.input-box')
                
                if(commentBox.hasClass('hidden'))
                    commentBox.removeClass('hidden');
                
                commentBox.find('textarea').focus()
            });
            
            setCommentFormsBehaviour()
        });
        
        
        function setCommentFormsBehaviour(){
            
            $('.commentForm').find("textarea").focus(function(){
                $(this).css('color','black');
                if($(this).attr('empty')=="true"){
                    $(this).css('width','430px');
                    $(this).css('font-style','normal');
                    $(this).css('font-size','1.1em');
                    $(this).parent().parent().find("img").removeClass('hidden');
                    //Guardamos y machamos el mensaje
                    $(this).attr('msg',$(this).text())
                    $(this).text("");
                }
            })
            
            $('.commentForm').find("textarea").blur(function(){
                if($(this).val()=="")
                    $(this).attr('empty',"true");
                
                if($(this).attr('empty')=="true")
                    resetInput(this)
                
            })
            
            $('.commentForm').find("textarea").keyup(function(e) {
                e.preventDefault();
                if(e.keyCode == 13) {
                    //If keypress==enter -> submit
                    
                    
                    suggestion_id=$(this).parent().parent().parent().attr('value')
                    sendComment2($(this),suggestion_id);
                    
                    $(this).val("");
                    $(this).blur();
                    resetInput(this)
                    
                    
                }else{
                    var height=(parseInt($(this).val().length/55)+1)*1.2;
                    if($(this).css('height')!=height)
                        $(this).css('height',height+'em');
                    if($(this).val().length>0)
                        $(this).attr('empty',"false")
                    else
                        $(this).attr('empty',"true")
                }
            });
        }
        
        function resetInput(obj){
            
            $(obj).css('width','470px');
            $(obj).css('color','#999');
            $(obj).css('font-style','italic');
            $(obj).css('font-size','0.9em');
            $(obj).parent().parent().find("img").addClass('hidden');
            
            //Reestablecemos el mensaje
            $(obj).attr('empty',"true")
            $(obj).text($(obj).attr('msg'));
            
            $(obj).focusout()
        }
        function vote(type,obj,value){
            var element_id=obj.attr('value')
            
            $.ajax({
                    type: "POST",
                    url: "/ajax/vote/"+type+"/",
                    data: {
                        instance_id:element_id,
                        puntuation: value,
                    },
                    dataType:'json',
                    success: function(msg){
                        //console.log(msg)
                        //if(msg!=false){
                            action=obj.attr('class')
                            obj.addClass('hidden')
                            
                            if(action=="LikeComment")
                                obj.parent().find(".dontLikeComment").removeClass('hidden')
                            else if (action=="dontLikeComment")
                                obj.parent().find(".LikeComment").removeClass('hidden')
                                
                            if(action=="LikeSuggestion")
                                obj.parent().find(".dontLikeSuggestion").removeClass('hidden')
                            else if (action=="dontLikeSuggestion")
                                obj.parent().find(".LikeSuggestion").removeClass('hidden')
                        //}
                    },
                    error:function(){
                    }
                    
                });   
        }

        
        

    
        function sendComment2(textarea,suggestion_id){
            if(textarea.val()=="")
                return false;
            else{
                msg=textarea.val();
                msg=msg.substring(0,msg.length-1);
            }
                        
            $.ajax({
                type: "POST",
                url: "/ajax/add/comment/event/",
                dataType:'json',
                data: {
                    instance_id:suggestion_id,
                    msg:msg
                },
                success: function(response){

                    //console.log(response)
                    textarea.parent()
                    c=$('#commentTemplate').tmpl(response).appendTo('#commentList-'+suggestion_id);
                    c.find(".like-dislike").like();
                    //resetInput(textarea);
                    initRemovable();
                    resizeIframe();
                },
                error:{
                }
            });
        }
    </script>
{%endblock%}

{% block title %}Dashboard{% endblock %}
{% block goBack %}{%endblock%}
{% block body %}
    <div {% block id %} {%endblock%}>
        
        {% block pre_chronology %} {%endblock%}
        
        {% if chronology.1|length %}    
    <!--
            <p>{{chronology.1.0}} mensajes</p>
    -->
            <ul id="chronology">
            {% for obj in chronology.1 %}
                <li id="suggestion_{{obj.instance.id}}" class="suggestion-element" {%if not forloop.last %}style="border-bottom: 1px solid #DDDDDD;"{% endif %}>
<div>
<!--
                {{obj}}
-->
                    <div class="avatar">
                        <a href="/fb/user/{{obj.username}}" title="Ver perfil en GeoRemindMe">
                            <img src="/user/{{obj.username}}/picture/" alt="{{obj.username}} avatar"/>
                        </a>
                    </div>
                    
                        <!--Solo si el mensaje ha sido generado por el usuario y no por el sistema se podrá borrar-->
                        {% if not obj.is_private %}
                            {% if obj.username = user.username %}
                                <div class="removable" value="{{obj.instance.id}}" type="suggestion"><a href="#">Remove</a></div>
                            {% endif %}
                        {% endif %}
                        {{obj.msg|safe}} <br>
                        {% if obj.instance.poi.slug %}
                            <span class="suggestionPlace">En <a href="/fb/place/{{obj.instance.poi.slug}}">{{obj.instance.poi.name}}</a></span><br>
                        {% endif %}
                        
                        
                        <span class="timestamp">{{obj.created|timesince}} ago</span>  
                        
                        <!--Si el mensaje lo leen más personas se añade una barra de acciones -->
                        {% if not obj.is_private %}
                        
                            <span class="action-bar">
                                | <span class="focusInput">Comentar</span> | 
                                <a href="/fb/suggestion/{{obj.instance.id|urlencode}}">Detalles</a> | 
                                
                                
                                
                                <span class="like-dislike" value="{{obj.instance.id}}" {% if obj.has_voted %}like="true"{%endif%} type="suggestion">
                                    <span class="dislike">
                                        <span class="hoverlink">Ya no me gusta</span> 
                                        <span class="text like-text {% if not obj.has_voted %}increase{% endif %}">{{obj.vote_counter}}</span> personas
                                    </span>
                                    
                                    <span class="like">
                                        Me gusta
                                    </span>
                                </span>
                                
                                | <span onclick="" title="Guardar en favoritos" class="save">Recordar</span>
                            </span>
                            
                            
                            
                            
                            
                            </div>
                            
                            <!-- Si hay comentarios en la sugerencia -->
                            
                            <div class="comment-box" value="{{obj.instance.id}}">
                                {% if obj.comments.1|length > 2%}
                                    <div class="show-all-comments">Ver los {{obj.comments.1|length}} comentarios</div>
                                {% endif %}
                                <ul id="commentList-{{obj.instance.id}}">
                                    {% if obj.comments.1 %}
                                        {% for c in obj.comments.1 reversed %}
                                            <li {% if forloop.revcounter > 2 %} class="long-list" {% endif %}>
                                                
                                                <!-- Añadimos el botón de borrar comentario-->
                                                {% if c.username = user.username %}
                                                    <div class="removable" value="{{c.id}}" type="comment"><a href="#">Remove</a></div>
                                                {% endif %}
                                            
                                                <img src="/user/{{c.username}}/picture/" alt="user avatar"><a href="/fb/user/{{c.username}}/">{{c.username}}</a>: {{c.msg}}<br>
                                                <span class="timestamp">{{c.created|timesince}} ago</span> - 
                                                
                                                
                                                <span class="like-dislike" value="{{c.id}}" {% if c.has_voted %}like="true"{%endif%} type="comment">
                                
                                                    <span class="dislike" {% if not c.has_voted %}style="display:none;"{%endif%} >
                                                        <span class="hoverlink">Ya no me gusta</span> 
                                                        <span class="text like-text {% if not c.has_voted %}increase{% endif %}">{{c.vote_counter}}</span> personas
                                                    </span>
                                                    
                                                    <span class="like" {% if c.has_voted %}style="display:none;"{%endif%} >
                                                        <span class="hoverlink">Me gusta</span> 
                                                    </span>
                                                </span>
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                                
                                <div class="input-box {% if not obj.comments.1 %} hidden {% endif %}">
                                    <img alt="user avatar" src="/user/{{user.username}}/picture/" class="min-img hidden">
                                    <form class="commentForm"><textarea empty="true" class="autogrow">Escribe un comentario</textarea></form>
                                </div>
                                
                            </div>
                        {% endif %}
                    
                    
                </li>
            {% endfor %}
            </ul>
        
            <!-- Si hay más mensajes -->
            {% if chronology.1|length == 15%}
                <div class="load-more">Cargar más</div>
            {% endif %}    
            
            
        {% endif %}    
    
        
        {% block pos_chronology %}{%endblock%}

    </div>


    
    
    <script id="commentTemplate" type="text/x-jquery-tmpl">
        <li>
            <img src="/user/{{user.username}}/picture/" alt="user avatar"><a href="/fb/user/{{user.username}}/">{{user.username}}</a>: ${msg}<br>
            <span class="timestamp">0 minutes ago</span> - 
            
            
            <span class="like-dislike" value="${id}" type="comment">

                <span class="dislike" style="display:none;">
                    <span class="hoverlink">Ya no me gusta</span> 
                    <span class="text like-text">1</span> personas
                </span>
                
                <span class="like">
                    <span class="hoverlink">Me gusta</span> 
                </span>
            </span>
        </li>
    </script>    
{% endblock %}

